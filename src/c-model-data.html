<html><head><link rel="import" href="../bower_components/polymer/polymer.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html"><link rel="import" href="c-model-categories.html"></head><body><dom-module id="c-model-data"><template><c-model-categories id="idModelCategories"></c-model-categories><iron-localstorage name="c-model-data" value="{{listRateModified}}" on-iron-localstorage-load-empty="_onIronLocalStorageLoadEmpty"></iron-localstorage><iron-ajax url="[[url]]" auto="" handle-as="json" on-response="_onResponse"></iron-ajax></template><script>"use strict";Polymer({is:"c-model-data",properties:{categories:{type:Array,notify:!1,readOnly:!1},category:{type:String,observer:"_analyzeRequest",notify:!1,readOnly:!1},listHome:{type:Array,notify:!0,readOnly:!1},listByCategory:{type:Array,notify:!0,readOnly:!1},url:String,idItem:{type:String,observer:"_getDataItem",notify:!1,readOnly:!1},dataItem:{type:Object,notify:!0,readOnly:!1},dataCart:{type:Array,notify:!1,readOnly:!1},loadingCategory:{type:Boolean,value:!1,notify:!0,readOnly:!1},isOffline:{type:Boolean,observer:"_retryRequest",notify:!1,readOnly:!1},listRateModified:{type:Array,value:function(){return[]},notify:!1,readOnly:!1}},_onIronLocalStorageLoadEmpty:function(){this.set("listRateModified",[])},_getDataItem:function(){var a=this.listByCategory.find(function(a){return a.id===this.idItem}.bind(this));a.genre=this.categories.find(function(b){return a.idGenre===b.id}).name,this.dataItem=a},_retryRequest:function(a,b){!a&&b&&this._analyzeRequest(this.category)},_analyzeRequest:function(a){this.dataItem=null,this.category=a,this.isOffline?"caches"in window&&caches.match(this.setUrl(a)).then(function(a){a?a.json().then(function(a){this._onResponse({detail:{response:a}})}.bind(this)):this._onResponse({detail:{response:[]}})}.bind(this)):(this.url!==this.setUrl(a)&&(this.loadingCategory=!0),this.url=this.setUrl(a))},_onResponse:function(a){"Home"===this.category?this.listHome=a.detail.response:(a.detail.response.forEach(function(a){a.nameCategory=this.category}.bind(this)),this.listByCategory=a.detail.response,this.listByCategory.forEach(function(a){a.isAddCart=this.dataCart.some(function(b){return b.id===a.id}),a.rate=this.getRateStoraged(a.id)||a.rate}.bind(this))),this.loadingCategory=!1},setUrl:function(a){return this.rootPath+"data/"+a+".json"},modifyRate:function(a){var b=this.listByCategory.findIndex(function(b){return b.id===a.idItem});this.set(["listByCategory",b,"rate"],a.rate),this.set(["dataItem","rate"],a.rate);var b=this.listRateModified.findIndex(function(b){return a.idItem===b.id}),c={id:a.idItem,rate:a.rate};this.splice("listRateModified",-1===b?this.listRateModified.length:b,1,c)},setItemCart:function(a,b){var c=this.listByCategory.findIndex(function(b){return b.id===a.id});this.set(["listByCategory",c,"isAddCart"],!!b),this.set(["dataItem","isAddCart"],!!b)},getRateStoraged:function(a){var b=this.listRateModified.find(function(b){return b.id===a});return b?b.rate:null}});</script></dom-module></body></html>